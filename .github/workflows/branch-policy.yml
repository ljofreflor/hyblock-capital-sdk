name: Branch Policy

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  enforce-branch-policy:
    name: Enforce Branch Policy
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate PR to main only from develop
        if: github.event_name == 'pull_request'
        env:
          HEAD_REF: ${{ github.head_ref }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          echo "üîç Validando pol√≠tica de ramas..."
          echo "Base: $BASE_REF | Head: $HEAD_REF"
          
          if [ "$BASE_REF" = "main" ] && [ "$HEAD_REF" != "develop" ]; then
            echo "‚ùå [POLICY VIOLATION] Solo se permiten PRs a main desde la rama 'develop'."
            echo "‚ùå Rama origen: $HEAD_REF (debe ser 'develop')"
            echo "‚ùå Rama destino: $BASE_REF"
            exit 1
          fi
          
          echo "‚úÖ [POLICY] Regla de ramas cumplida - PR desde $HEAD_REF a $BASE_REF"
      
      - name: Block direct push to main
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "‚ùå [POLICY VIOLATION] Push directo a main no permitido."
          echo "‚ùå Solo se permiten PRs desde develop que pasen los tests unitarios."
          echo "‚ùå Usa: git push origin develop y crea un PR"
          exit 1
      
      - name: Run unit tests for PR validation
        if: github.event_name == 'pull_request' && github.base_ref == 'main'
        run: |
          echo "üß™ Ejecutando tests unitarios para validar PR..."
          
          # Verificar que Python est√© disponible
          python --version || python3 --version
          
          # Verificar que Poetry est√© disponible
          poetry --version
          
          # Instalar dependencias
          poetry install --with dev
          
          # Ejecutar tests unitarios
          echo "üîç Ejecutando tests unitarios..."
          poetry run pytest tests/ -v --tb=short
          
          echo "‚úÖ Tests unitarios pasaron exitosamente"
      
      - name: Validate PR requirements
        if: github.event_name == 'pull_request' && github.base_ref == 'main'
        run: |
          echo "üìã Validando requisitos del PR..."
          
          # Verificar que el PR tenga descripci√≥n
          if [ -z "${{ github.event.pull_request.body }}" ]; then
            echo "‚ö†Ô∏è  Advertencia: El PR no tiene descripci√≥n"
          else
            echo "‚úÖ PR tiene descripci√≥n"
          fi
          
          # Verificar que no sea un draft
          if [ "${{ github.event.pull_request.draft }}" = "true" ]; then
            echo "‚ùå [POLICY] No se permiten PRs en draft a main"
            exit 1
          fi
          
          echo "‚úÖ PR cumple con los requisitos b√°sicos"


