name: Post-Publish PyPI Test

on:
  push:
    tags:
      - 'v*'  # Triggered by version tags

jobs:
  test-after-publish:
    name: Test After Publish
    runs-on: ubuntu-latest
    
    steps:
    - name: Wait for PyPI propagation
      run: |
        echo "â³ Waiting for PyPI to propagate changes..."
        sleep 60  # Esperar 1 minuto para que PyPI se actualice
    
    - name: Setup Poetry
      run: |
        echo "ðŸ Installing Poetry..."
        curl -sSL https://install.python-poetry.org | python3 -
        export PATH="$HOME/.local/bin:$PATH"
        poetry --version

    - name: Test published version
      run: |
        echo "ðŸ” Testing published version..."
        
        # Obtener versiÃ³n del tag
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "Testing version: $VERSION"
        
        # Crear entorno limpio en directorio temporal
        mkdir -p /tmp/version-test
        cd /tmp/version-test
        
        # Crear pyproject.toml manualmente
        cat > pyproject.toml << EOF
        [tool.poetry]
        name = "test-version-installation"
        version = "0.1.0"
        description = "Test specific version installation from PyPI"
        authors = ["Test User <test@example.com>"]
        
        [tool.poetry.dependencies]
        python = "^3.9"
        
        [build-system]
        requires = ["poetry-core"]
        build-backend = "poetry.core.masonry.api"
        EOF
        
        # Instalar versiÃ³n especÃ­fica desde PyPI usando Poetry
        export PATH="$HOME/.local/bin:$PATH"
        poetry add hyblock-capital-sdk==$VERSION
        
        # Verificar instalaciÃ³n
        poetry run python -c "import hyblock_capital_sdk; print('âœ… Version $VERSION installed successfully')"
        poetry run python -c "from hyblock_capital_sdk import ApiClient, Configuration, CatalogApi; print('âœ… Core components working')"
        
        # Verificar que es la versiÃ³n correcta
        INSTALLED_VERSION=$(poetry show hyblock-capital-sdk | grep version | cut -d' ' -f4)
        if [ "$INSTALLED_VERSION" = "$VERSION" ]; then
          echo "âœ… Correct version installed: $VERSION"
        else
          echo "âŒ Version mismatch: expected $VERSION, got $INSTALLED_VERSION"
          exit 1
        fi
        
        # Limpiar directorio temporal
        cd /
        rm -rf /tmp/version-test
    
    - name: Test with Docker
      run: |
        echo "ðŸ³ Testing with Docker..."
        
        VERSION=${GITHUB_REF#refs/tags/v}
        
        # Crear pyproject.toml temporal
        cat > pyproject.toml.tmp << 'PYPROJ'
        [tool.poetry]
        name = "test-hyblock-sdk"
        version = "0.1.0"
        description = "Test installation from PyPI"
        authors = ["Test User <test@example.com>"]
        
        [tool.poetry.dependencies]
        python = "^3.9"
        
        [build-system]
        requires = ["poetry-core"]
        build-backend = "poetry.core.masonry.api"
        PYPROJ
        
        # Crear Dockerfile para versiÃ³n especÃ­fica
        cat > Dockerfile.version-test << EOF
        FROM python:3.9-slim
        
        WORKDIR /app
        
        RUN apt-get update && apt-get install -y \\
            build-essential \\
            curl \\
            && rm -rf /var/lib/apt/lists/*
        
        RUN pip install poetry
        RUN poetry config virtualenvs.create false
        
        # Copiar pyproject.toml
        COPY pyproject.toml.tmp /app/pyproject.toml
        
        # Instalar versiÃ³n especÃ­fica
        RUN poetry add hyblock-capital-sdk==$VERSION
        
        # Verificar
        RUN python -c "import hyblock_capital_sdk; print('âœ… SUCCESS: Version $VERSION installed')"
        RUN python -c "from hyblock_capital_sdk import ApiClient, Configuration, CatalogApi; print('âœ… SUCCESS: Core components working')"
        
        CMD ["python", "-c", "import hyblock_capital_sdk; print('âœ… Docker version test completed successfully!')"]
        EOF
        
        # Construir y ejecutar
        docker build -f Dockerfile.version-test -t hyblock-sdk-version-test .
        docker run --rm hyblock-sdk-version-test
        
        echo "âœ… Docker version test passed!"
    
    - name: Verify PyPI listing
      run: |
        echo "ðŸ” Verifying PyPI listing..."
        
        VERSION=${GITHUB_REF#refs/tags/v}
        
        # Verificar que la versiÃ³n aparece en PyPI
        if pip index versions hyblock-capital-sdk | grep -q "$VERSION"; then
          echo "âœ… Version $VERSION found in PyPI"
        else
          echo "âŒ Version $VERSION not found in PyPI"
          exit 1
        fi
        
        echo "âœ… PyPI listing verification passed!"
